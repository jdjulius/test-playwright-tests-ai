# .github/workflows/playwright-tests.yml
name: Playwright Tests CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  CODEBUILD_PROJECT_NAME: playwright-tests-project

jobs:
  trigger-codebuild:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Start CodeBuild
        id: codebuild
        run: |
          BUILD_ID=$(aws codebuild start-build \
            --project-name ${{ env.CODEBUILD_PROJECT_NAME }} \
            --source-version ${{ github.sha }} \
            --query 'build.id' \
            --output text)
          echo "build-id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Started CodeBuild: $BUILD_ID"

      - name: Wait for CodeBuild completion
        run: |
          BUILD_ID="${{ steps.codebuild.outputs.build-id }}"
          echo "Waiting for build $BUILD_ID to complete..."

          while true; do
            BUILD_STATUS=$(aws codebuild batch-get-builds \
              --ids $BUILD_ID \
              --query 'builds[0].buildStatus' \
              --output text)
            
            echo "Current status: $BUILD_STATUS"
            
            if [ "$BUILD_STATUS" = "SUCCEEDED" ]; then
              echo "Build completed successfully!"
              break
            elif [ "$BUILD_STATUS" = "FAILED" ] || [ "$BUILD_STATUS" = "FAULT" ] || [ "$BUILD_STATUS" = "STOPPED" ] || [ "$BUILD_STATUS" = "TIMED_OUT" ]; then
              echo "Build failed with status: $BUILD_STATUS"
              exit 1
            fi
            
            sleep 30
          done

      - name: Download test artifacts
        run: |
          BUILD_ID="${{ steps.codebuild.outputs.build-id }}"
          ARTIFACT_LOCATION=$(aws codebuild batch-get-builds \
            --ids $BUILD_ID \
            --query 'builds[0].artifacts.location' \
            --output text)

          if [ "$ARTIFACT_LOCATION" != "None" ] && [ "$ARTIFACT_LOCATION" != "null" ]; then
            echo "Raw artifact location: $ARTIFACT_LOCATION"
            # Convert ARN to S3 URI (arn:aws:s3:::bucket/path -> s3://bucket/path)
            S3_URI=$(echo $ARTIFACT_LOCATION | sed 's/arn:aws:s3:::/s3:\/\//')
            echo "Downloading artifacts from: $S3_URI"
            mkdir -p ./artifacts
            aws s3 cp $S3_URI ./artifacts/ --recursive
          else
            echo "No artifacts to download"
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: |
            artifacts/

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './artifacts/test-results/results.json';

            if (fs.existsSync(path)) {
              const results = JSON.parse(fs.readFileSync(path, 'utf8'));
              const { stats } = results;
              
              const body = `## üé≠ Playwright Test Results
              
              | Metric | Value |
              |--------|-------|
              | ‚úÖ Passed | ${stats.passed} |
              | ‚ùå Failed | ${stats.failed} |
              | ‚è≠Ô∏è Skipped | ${stats.skipped} |
              | ‚è±Ô∏è Duration | ${Math.round(stats.duration / 1000)}s |
              
              [View detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
